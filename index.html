<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>工数実績収集フォーム（フレームワーク不要・QR対応）</title>

  <!-- jsQR（CDN）。社内でブロックされる場合は、このファイルをリポジトリに保存し相対パスに変更してください。 -->
  <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>

  <!-- 製造ラインマスタ（どちらか一方でOK） -->
  <!-- 1) 日本語名のまま： window.製造ラインマスタ = [...] -->
  <script src="製造ラインマスタ.js"></script>
  <!-- 2) ASCII名にした場合（推奨）： window.SEIZO_LINE_MASTER = [...] -->
  <!-- <script src="seizo_line_master.js"></script> -->

  <style>
    :root {
      --bg: #f3f4f6;
      --panel: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --primary: #2563eb;
      --primary-600: #1d4ed8;
      --danger: #ef4444;
      --danger-600: #dc2626;
      --border: #e5e7eb;
      --green: #16a34a;
      --yellow: #ca8a04;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans JP', Arial, sans-serif; background: var(--bg); color: var(--text); }
    .container { max-width: 1024px; margin: 0 auto; padding: 16px; }
    .card { background: var(--panel); border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,.06); padding: 24px; margin-bottom: 24px; }
    h1 { font-size: 22px; margin: 0 0 16px; }
    h2 { font-size: 18px; margin: 0 0 12px; }
    label { display:block; font-size: 14px; margin-bottom: 6px; }
    input[type="text"], input[type="date"], input[type="number"], select {
      width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; outline: none;
    }
    input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15); }
    .row { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 768px) { .row { grid-template-columns: 1fr 1fr; } }
    .btn { display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius: 8px; border:none; cursor:pointer; font-weight: 600; font-size: 14px; }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: var(--primary-600); }
    .btn-danger { background: var(--danger); color: #fff; }
    .btn-danger:hover { background: var(--danger-600); }
    .btn-ghost { background: #111827; color: #fff; }
    .btn-ghost:hover { background: #0b1220; }
    .muted { color: var(--muted); font-size: 12px; }
    .help { color: var(--muted); font-size: 12px; margin-top: 6px; }
    .error { color: var(--danger-600); font-size: 12px; margin-top: 6px; }
    .ok { color: var(--green); font-size: 12px; }
    .warn { color: var(--yellow); font-size: 12px; }
    .toolbar { display:flex; gap: 10px; }
    .video-wrap { background: #000; border-radius: 8px; overflow: hidden; }
    video { width: 100%; height: auto; display:block; object-fit: contain; background: #000; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    thead th { text-align: left; color: #374151; background:#f9fafb; padding: 8px; border-bottom: 1px solid var(--border); }
    tbody td { padding: 8px; border-bottom: 1px solid var(--border); }
    .text-right { text-align: right; }
    .text-center { text-align: center; }
    .grid-3 { display:grid; grid-template-columns: 1fr; gap:12px; }
    @media (min-width: 768px){ .grid-3 { grid-template-columns: 2fr 1fr auto; } }
    .hidden { display:none; }
    .badge { font-size: 12px; padding: 2px 6px; border-radius: 999px; }
    .badge-ok { background: #dcfce7; color: #166534; }
    .badge-warn { background: #fef9c3; color: #854d0e; }
    .badge-err { background: #fee2e2; color: #991b1b; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>工数実績収集フォーム</h1>

      <!-- 製造ラインマスタ -->
      <div class="card" style="padding:16px; margin-bottom:16px;">
        <div class="grid-3">
          <div>
            <div style="font-size:14px; font-weight:600; margin-bottom:4px;">製造ラインマスタ</div>
            <div id="masterStatus" class="muted">読み込み中…</div>
          </div>
          <div></div>
          <div style="display:flex; justify-content:flex-end; align-items:center;">
            <button id="btnReloadMaster" class="btn btn-primary">製造ラインマスタ読込</button>
          </div>
        </div>
      </div>

      <!-- カメラ選択 -->
      <div class="card" style="padding:16px; margin-bottom:16px;">
        <div class="row" style="grid-template-columns: 2fr 1fr;">
          <div>
            <label>使用カメラ</label>
            <select id="cameraSelect"></select>
            <div class="help">※ ブラウザのカメラ許可後にラベルが表示されます</div>
          </div>
          <div style="display:flex; align-items:flex-end;">
            <button id="btnRefreshCameras" class="btn btn-ghost" style="width:100%;">カメラ再検出</button>
          </div>
        </div>
      </div>

      <!-- スキャナビュー -->
      <div id="scannerPanel" class="card hidden" style="padding:16px; margin-bottom:16px;">
        <div class="grid-3" style="grid-template-columns: 1fr auto;">
          <div><h2>QRコードをスキャン</h2></div>
          <div style="display:flex; justify-content:flex-end;">
            <button id="btnStopScan" class="btn btn-danger">キャンセル</button>
          </div>
        </div>
        <div class="video-wrap">
          <video id="video" autoplay muted playsinline></video>
        </div>
        <canvas id="canvas" class="hidden"></canvas>
        <div id="scanError" class="error" style="margin-top:8px;"></div>
      </div>

      <!-- 入力エリア -->
      <div class="row">
        <div>
          <label>記入日 <span class="badge badge-err">必須</span></label>
          <input type="date" id="dateInput" />
          <div id="err_date" class="error"></div>
        </div>

        <div>
          <label>指図書番号 <span class="badge badge-err">必須</span></label>
          <div class="toolbar">
            <input type="text" id="orderInput" placeholder="手入力またはスキャン" style="flex:1;" />
            <button id="btnStartScan" class="btn btn-primary" title="カメラを起動してQRを読み取る">カメラ</button>
          </div>
          <div id="err_order" class="error"></div>
        </div>

        <div>
          <label>製造場所コード <span class="badge badge-err">必須</span></label>
          <select id="locSelect"></select>
          <div id="err_loc" class="error"></div>
        </div>

        <div>
          <label>製造ラインコード <span class="badge badge-err">必須</span></label>
          <select id="lineSelect" disabled></select>
          <div id="err_line" class="error"></div>
        </div>

        <div>
          <label>工程 <span class="badge badge-err">必須</span></label>
          <select id="procSelect">
            <option value="">選択してください</option>
            <option value="充填">充填</option>
            <option value="包装">包装</option>
          </select>
          <div id="err_proc" class="error"></div>
        </div>

        <div>
          <label>段取り（時間） <span class="badge badge-err">必須</span></label>
          <input type="number" id="setupInput" step="0.25" min="0" />
          <div id="err_setup" class="error"></div>
        </div>

        <div>
          <label>実生産（時間） <span class="badge badge-err">必須</span></label>
          <input type="number" id="prodInput" step="0.25" min="0" />
          <div id="err_prod" class="error"></div>
        </div>

        <div>
          <label>余裕（時間） <span class="badge badge-err">必須</span></label>
          <input type="number" id="allowInput" step="0.25" min="0" />
          <div id="err_allow" class="error"></div>
        </div>

        <div>
          <label>開梱（時間） <span class="badge badge-err">必須</span></label>
          <input type="number" id="unpackInput" step="0.25" min="0" />
          <div id="err_unpack" class="error"></div>
        </div>

        <div>
          <label>手直し（時間） <span class="badge badge-err">必須</span></label>
          <input type="number" id="reworkInput" step="0.25" min="0" />
          <div id="err_rework" class="error"></div>
        </div>

        <div>
          <label>人数 <span class="badge badge-err">必須</span></label>
          <input type="number" id="peopleInput" step="1" min="1" />
          <div id="err_people" class="error"></div>
        </div>
      </div>

      <div style="margin-top:16px;">
        <button id="btnAdd" class="btn btn-primary" style="width:100%;">レコードを追加</button>
      </div>
    </div>

    <!-- 一覧 & CSV -->
    <div id="listCard" class="card hidden">
      <div class="grid-3" style="grid-template-columns: 1fr auto;">
        <h2>登録済みデータ <span id="recCount" class="muted"></span></h2>
        <div style="display:flex; justify-content:flex-end;">
          <button id="btnCSV" class="btn btn-primary">CSV出力</button>
        </div>
      </div>

      <div style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>記入日</th>
              <th>指図書番号</th>
              <th>製造場所</th>
              <th>製造ライン</th>
              <th>工程</th>
              <th class="text-right">段取り</th>
              <th class="text-right">実生産</th>
              <th class="text-right">余裕</th>
              <th class="text-right">開梱</th>
              <th class="text-right">手直し</th>
              <th class="text-right">人数</th>
              <th class="text-center">操作</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // ==========================
    // 状態
    // ==========================
    const state = {
      records: [],
      current: {
        date: new Date().toISOString().split('T')[0],
        orderNumber: '',
        locationCode: '',
        lineCode: '',
        process: '',
        setup: '',
        production: '',
        allowance: '',
        unpacking: '',
        rework: '',
        people: ''
      },
      lineMaster: [],
      filteredLines: [],
      cameras: [],
      selectedDeviceId: '',
      scanning: false,
      scanTimer: null,
      stream: null
    };

    // ==========================
    // 要素取得
    // ==========================
    const masterStatus = document.getElementById('masterStatus');
    const btnReloadMaster = document.getElementById('btnReloadMaster');
    const cameraSelect = document.getElementById('cameraSelect');
    const btnRefreshCameras = document.getElementById('btnRefreshCameras');
    const scannerPanel = document.getElementById('scannerPanel');
    const btnStartScan = document.getElementById('btnStartScan');
    const btnStopScan = document.getElementById('btnStopScan');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const scanError = document.getElementById('scanError');

    const dateInput = document.getElementById('dateInput');
    const orderInput = document.getElementById('orderInput');
    const locSelect = document.getElementById('locSelect');
    const lineSelect = document.getElementById('lineSelect');
    const procSelect = document.getElementById('procSelect');
    const setupInput = document.getElementById('setupInput');
    const prodInput = document.getElementById('prodInput');
    const allowInput = document.getElementById('allowInput');
    const unpackInput = document.getElementById('unpackInput');
    const reworkInput = document.getElementById('reworkInput');
    const peopleInput = document.getElementById('peopleInput');

    const err_date = document.getElementById('err_date');
    const err_order = document.getElementById('err_order');
    const err_loc = document.getElementById('err_loc');
    const err_line = document.getElementById('err_line');
    const err_proc = document.getElementById('err_proc');
    const err_setup = document.getElementById('err_setup');
    const err_prod = document.getElementById('err_prod');
    const err_allow = document.getElementById('err_allow');
    const err_unpack = document.getElementById('err_unpack');
    const err_rework = document.getElementById('err_rework');
    const err_people = document.getElementById('err_people');

    const btnAdd = document.getElementById('btnAdd');
    const listCard = document.getElementById('listCard');
    const recCount = document.getElementById('recCount');
    const btnCSV = document.getElementById('btnCSV');
    const tbody = document.getElementById('tbody');

    // ==========================
    // 初期化
    // ==========================
    function init() {
      dateInput.value = state.current.date;
      orderInput.value = '';
      fillLocationCodes();
      fillLines([]);

      attachEvents();

      loadMaster();
      enumerateCameras();

      // 既定プロセスは空
      procSelect.value = '';
    }

    function attachEvents() {
      btnReloadMaster.addEventListener('click', loadMaster);
      btnRefreshCameras.addEventListener('click', enumerateCameras);

      locSelect.addEventListener('change', () => {
        state.current.locationCode = locSelect.value;
        filterLines();
      });

      lineSelect.addEventListener('change', () => {
        state.current.lineCode = lineSelect.value;
      });

      dateInput.addEventListener('change', () => state.current.date = dateInput.value);

      orderInput.addEventListener('input', () => state.current.orderNumber = orderInput.value);
      orderInput.addEventListener('blur', () => {
        const numbers = (state.current.orderNumber || '').replace(/\D/g, '');
        state.current.orderNumber = numbers.padStart(15, '0').slice(0, 15);
        orderInput.value = state.current.orderNumber;
      });

      procSelect.addEventListener('change', () => state.current.process = procSelect.value);
      setupInput.addEventListener('input', () => state.current.setup = setupInput.value);
      prodInput.addEventListener('input', () => state.current.production = prodInput.value);
      allowInput.addEventListener('input', () => state.current.allowance = allowInput.value);
      unpackInput.addEventListener('input', () => state.current.unpacking = unpackInput.value);
      reworkInput.addEventListener('input', () => state.current.rework = reworkInput.value);
      peopleInput.addEventListener('input', () => state.current.people = peopleInput.value);

      btnStartScan.addEventListener('click', startScan);
      btnStopScan.addEventListener('click', stopScan);

      btnAdd.addEventListener('click', addRecord);
      btnCSV.addEventListener('click', downloadCSV);

      cameraSelect.addEventListener('change', () => {
        state.selectedDeviceId = cameraSelect.value;
      });
    }

    function fillLocationCodes() {
      const options = ['M0HZ','M1HZ','M2HZ','M3HZ','M4HZ'];
      locSelect.innerHTML = '<option value="">選択してください</option>' + options.map(code =>
        `<option value="${code}">${code}</option>`
      ).join('');
      locSelect.value = '';
    }

    function fillLines(lines) {
      lineSelect.innerHTML = '<option value="">選択してください</option>' + lines.map(line =>
        `<option value="${escapeHtml(line.製造ラインコード)}">${escapeHtml(line.製造ラインコード)} - ${escapeHtml(line.製造ライン名 || '')}</option>`
      ).join('');
      lineSelect.disabled = lines.length === 0 || !state.current.locationCode;
      lineSelect.value = '';
    }

    function filterLines() {
      if (state.current.locationCode && state.lineMaster.length > 0) {
        state.filteredLines = state.lineMaster.filter(line =>
          line.製造場所コード === state.current.locationCode &&
          (line.使用停止フラグ === 0 || line.使用停止フラグ === '0')
        );
        fillLines(state.filteredLines);
        if (!state.filteredLines.find(l => l.製造ラインコード === state.current.lineCode)) {
          state.current.lineCode = '';
        }
      } else {
        state.filteredLines = [];
        fillLines([]);
        state.current.lineCode = '';
      }
    }

    // ==========================
    // マスタ読込
    // ==========================
    function loadMaster() {
      try {
        const src =
          (typeof window.製造ラインマスタ !== 'undefined' && Array.isArray(window.製造ラインマスタ)) ? window.製造ラインマスタ :
          (typeof window.SEIZO_LINE_MASTER !== 'undefined' && Array.isArray(window.SEIZO_LINE_MASTER)) ? window.SEIZO_LINE_MASTER :
          null;

        if (src) {
          state.lineMaster = src.filter(row => (row.使用停止フラグ === 0 || row.使用停止フラグ === '0'));
          masterStatus.innerHTML = `<span class="ok">読み込み済み（${state.lineMaster.length}件）</span>`;
          filterLines();
        } else {
          state.lineMaster = [];
          masterStatus.innerHTML = `<span class="warn">製造ラインマスタが読み込まれていません（ファイルと変数名を確認）</span>`;
          filterLines();
        }
      } catch (e) {
        masterStatus.innerHTML = `<span class="error">製造ラインマスタの読み込みに失敗: ${escapeHtml(e.message)}</span>`;
      }
    }

    // ==========================
    // カメラ列挙
    // ==========================
    async function enumerateCameras() {
      try {
        try { await navigator.mediaDevices.getUserMedia({ video: true }); } catch(e){}
        const devices = await navigator.mediaDevices.enumerateDevices();
        const cams = devices.filter(d => d.kind === 'videoinput');
        state.cameras = cams;
        cameraSelect.innerHTML = cams.length === 0
          ? '<option value="">（カメラが見つかりません）</option>'
          : cams.map((c,i) => `<option value="${c.deviceId}">${escapeHtml(c.label || `カメラ ${i+1}`)}</option>`).join('');
        if (cams.length > 0) {
          state.selectedDeviceId = cams[0].deviceId;
          cameraSelect.value = state.selectedDeviceId;
        } else {
          state.selectedDeviceId = '';
        }
      } catch (e) {
        cameraSelect.innerHTML = '<option value="">（カメラ列挙に失敗）</option>';
        console.warn('カメラ列挙に失敗:', e);
      }
    }

    // ==========================
    // スキャン開始/停止
    // ==========================
    async function startScan() {
      scanError.textContent = '';
      if (!window.jsQR) {
        scanError.textContent = 'QRライブラリ(jsQR)が読み込まれていません。';
        return;
      }
      try {
        const constraints = state.selectedDeviceId
          ? { video: { deviceId: { exact: state.selectedDeviceId } } }
          : { video: true };

        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        state.stream = stream;

        video.srcObject = stream;
        video.setAttribute('playsinline', '');
        video.setAttribute('autoplay', '');
        video.muted = true;

        await playSafe(video);

        state.scanning = true;
        scannerPanel.classList.remove('hidden');
        scanLoop();
      } catch (err) {
        if (err.name === 'NotAllowedError') scanError.textContent = 'カメラアクセスが拒否されました。ブラウザの許可を確認してください。';
        else if (err.name === 'NotFoundError' || err.name === 'OverconstrainedError') scanError.textContent = '指定のカメラが見つかりません。別のカメラを選択してください。';
        else scanError.textContent = 'カメラアクセスに失敗: ' + err.message;
        console.error(err);
      }
    }

    function stopScan() {
      state.scanning = false;
      if (state.scanTimer) { clearTimeout(state.scanTimer); state.scanTimer = null; }
      if (state.stream) {
        state.stream.getTracks().forEach(t => t.stop());
        state.stream = null;
      }
      scannerPanel.classList.add('hidden');
    }

    async function playSafe(v) {
      const playFn = () => v.play().catch(err => {
        scanError.textContent = 'ビデオ再生に失敗: ' + err.message;
        console.error('video.play()失敗', err);
      });
      if (v.readyState >= 1) await playFn(); else v.onloadedmetadata = async () => { await playFn(); };
    }

    function scanLoop() {
      if (!state.scanning || !state.stream) return;
      const vw = video.videoWidth || 0;
      const vh = video.videoHeight || 0;
      if (vw > 0 && vh > 0) {
        const ctx = canvas.getContext('2d');
        const maxSide = 720;
        const scale = Math.min(1, maxSide / Math.max(vw, vh));
        canvas.width = Math.round(vw * scale);
        canvas.height = Math.round(vh * scale);
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(img.data, img.width, img.height, { inversionAttempts: 'dontInvert' });
        if (code && code.data) {
          state.current.orderNumber = String(code.data);
          orderInput.value = state.current.orderNumber;
          stopScan();
          return;
        }
      }
      state.scanTimer = setTimeout(scanLoop, 60);
    }

    // ==========================
    // 検証/追加/削除/CSV
    // ==========================
    function clearErrors() {
      [err_date, err_order, err_loc, err_line, err_proc, err_setup, err_prod, err_allow, err_unpack, err_rework, err_people]
        .forEach(el => el.textContent = '');
    }

    function validate() {
      clearErrors();
      const e = {};
      const tfields = ['setup','production','allowance','unpacking','rework'];

      if (!dateInput.value) e.date = '必須項目です。入力してください';
      if (!orderInput.value) e.order = '必須項目です。入力してください';
      if (!locSelect.value) e.loc = '必須項目です。入力してください';
      if (!lineSelect.value) e.line = '必須項目です。入力してください';
      if (!procSelect.value) e.proc = '必須項目です。入力してください';
      if (!setupInput.value) e.setup = '必須項目です。入力してください';
      if (!prodInput.value) e.prod = '必須項目です。入力してください';
      if (!allowInput.value) e.allow = '必須項目です。入力してください';
      if (!unpackInput.value) e.unpack = '必須項目です。入力してください';
      if (!reworkInput.value) e.rework = '必須項目です。入力してください';
      if (!peopleInput.value) e.people = '必須項目です。入力してください';

      tfields.forEach(key => {
        const el = {
          setup: setupInput, production: prodInput, allowance: allowInput, unpacking: unpackInput, rework: reworkInput
        }[key];
        if (el.value !== '') {
          const v = parseFloat(el.value);
          if (!isNaN(v)) {
            if (v < 0) e[key] = '負数は入力できません';
            else if ((v * 4) % 1 !== 0) e[key] = '0.25h単位で入力してください';
          }
        }
      });

      if (peopleInput.value !== '') {
        const v = parseFloat(peopleInput.value);
        if (!isNaN(v) && !Number.isInteger(v)) e.people = '整数で入力してください';
      }

      if (Object.keys(e).length) {
        if (e.date) err_date.textContent = e.date;
        if (e.order) err_order.textContent = e.order;
        if (e.loc) err_loc.textContent = e.loc;
        if (e.line) err_line.textContent = e.line;
        if (e.proc) err_proc.textContent = e.proc;
        if (e.setup) err_setup.textContent = e.setup;
        if (e.prod) err_prod.textContent = e.prod;
        if (e.allow) err_allow.textContent = e.allow;
        if (e.unpack) err_unpack.textContent = e.unpack;
        if (e.rework) err_rework.textContent = e.rework;
        if (e.people) err_people.textContent = e.people;
        return false;
      }
      return true;
    }

    function addRecord() {
      if (!validate()) return;
      const rec = {
        id: Date.now(),
        date: dateInput.value,
        orderNumber: orderInput.value,
        locationCode: locSelect.value,
        lineCode: lineSelect.value,
        process: procSelect.value,
        setup: setupInput.value,
        production: prodInput.value,
        allowance: allowInput.value,
        unpacking: unpackInput.value,
        rework: reworkInput.value,
        people: peopleInput.value
      };
      state.records.push(rec);
      renderTable();
      resetForm();
    }

    function resetForm() {
      dateInput.value = new Date().toISOString().split('T')[0];
      orderInput.value = '';
      locSelect.value = '';
      lineSelect.innerHTML = '<option value="">選択してください</option>';
      lineSelect.disabled = true;
      procSelect.value = '';
      setupInput.value = '';
      prodInput.value = '';
      allowInput.value = '';
      unpackInput.value = '';
      reworkInput.value = '';
      peopleInput.value = '';
      clearErrors();
    }

    function removeRecord(id) {
      state.records = state.records.filter(r => r.id !== id);
      renderTable();
    }

    function renderTable() {
      if (state.records.length === 0) {
        listCard.classList.add('hidden');
        return;
      }
      listCard.classList.remove('hidden');
      recCount.textContent = `（${state.records.length}件）`;
      tbody.innerHTML = state.records.map(r => `
        <tr>
          <td>${escapeHtml(r.date)}</td>
          <td>${escapeHtml(r.orderNumber)}</td>
          <td>${escapeHtml(r.locationCode)}</td>
          <td>${escapeHtml(r.lineCode)}</td>
          <td>${escapeHtml(r.process)}</td>
          <td class="text-right">${escapeHtml(r.setup)}</td>
          <td class="text-right">${escapeHtml(r.production)}</td>
          <td class="text-right">${escapeHtml(r.allowance)}</td>
          <td class="text-right">${escapeHtml(r.unpacking)}</td>
          <td class="text-right">${escapeHtml(r.rework)}</td>
          <td class="text-right">${escapeHtml(String(r.people))}</td>
          <td class="text-center">
            <button class="btn btn-danger" onclick="removeRecord(${r.id})">削除</button>
          </td>
        </tr>
      `).join('');
    }

    function downloadCSV() {
      if (state.records.length === 0) {
        alert('ダウンロードするデータがありません');
        return;
      }
      const headers = ['記入日','指図書番号','製造場所コード','製造ラインコード','工程','段取り','実生産','余裕','開梱','手直し','人数'];
      const rows = state.records.map(r => [
        r.date, r.orderNumber, r.locationCode, r.lineCode, r.process,
        r.setup, r.production, r.allowance, r.unpacking, r.rework, r.people
      ]);
      const csv = [headers, ...rows].map(a => a.map(csvEscape).join(',')).join('\n');
      const bom = '\uFEFF';
      const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `工数実績_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ==========================
    // ヘルパ
    // ==========================
    function escapeHtml(s) {
      return String(s==null?'':s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
    function csvEscape(s) {
      const t = String(s==null?'':s);
      return /[",\n]/.test(t) ? `"${t.replace(/"/g,'""')}"` : t;
    }

    // グローバル削除用
    window.removeRecord = removeRecord;

    // 起動
    init();
  </script>
</body>
</html>
