<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>工数実績収集フォーム（充填・仕上同時入力版）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
  <!-- 製造ラインマスタ（同ディレクトリ） -->
  <script src="製造ラインマスタ.js"></script>
  <style>
    /* QR枠用のオーバーレイ */
    .qr-canvas { position: absolute; inset: 0; pointer-events: none; }
    .video-wrap { position: relative; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    const Camera = ({ size=20 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
        <circle cx="12" cy="13" r="4"></circle>
      </svg>
    );
    const Download = ({ size=20 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="7 10 12 15 17 10"></polyline>
        <line x1="12" y1="15" x2="12" y2="3"></line>
      </svg>
    );
    const Plus = ({ size=20 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    );
    const Trash2 = ({ size=18 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="3 6 5 6 21 6"></polyline>
        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
      </svg>
    );
    const RefreshCw = ({ size=16 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="23 4 23 10 17 10"></polyline>
        <polyline points="1 20 1 14 7 14"></polyline>
        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
      </svg>
    );

    function WorkHoursForm() {
      const [records, setRecords] = useState([]);
      const [currentRecord, setCurrentRecord] = useState({
        date: new Date().toISOString().split('T')[0],
        orderNumber: '',
        locationCode: '',
        lineCode: '',
        filling: { setup:'', production:'', allowance:'', unpacking:'', rework:'', people:'' },
        finishing: { setup:'', production:'', allowance:'', unpacking:'', rework:'', people:'' }
      });
      const [errors, setErrors] = useState({});

      // マスタ
      const [lineMaster, setLineMaster] = useState([]);
      const [filteredLines, setFilteredLines] = useState([]);
      const [masterLoadError, setMasterLoadError] = useState('');

      // スキャンUI
      const [scanPanelOpen, setScanPanelOpen] = useState(false);
      const [isScanning, setIsScanning] = useState(false);
      const [scanError, setScanError] = useState('');
      const [scanInfo, setScanInfo] = useState('');

      const [cameras, setCameras] = useState([]);
      const [selectedDeviceId, setSelectedDeviceId] = useState('');

      const videoRef = useRef(null);
      const canvasRef = useRef(null);        // デコード用キャンバス（非表示）
      const overlayRef = useRef(null);       // 枠描画用キャンバス（表示）
      const streamRef = useRef(null);
      const jsQRRef = useRef(null);
      const isScanningRef = useRef(false);   // ループ用・最新状態を保持

      const locationCodeOptions = ['M0HZ','M1HZ','M2HZ','M3HZ','M4HZ'];

      useEffect(() => {
        // jsQR の参照を安定化
        if (window.jsQR) jsQRRef.current = window.jsQR;
        const t = setInterval(() => {
          if (!jsQRRef.current && window.jsQR) { jsQRRef.current = window.jsQR; clearInterval(t); }
        }, 120);
        loadMasterData();
        return () => clearInterval(t);
      }, []);

      useEffect(() => {
        if (currentRecord.locationCode && lineMaster.length > 0) {
          const filtered = lineMaster.filter(line =>
            line.製造場所コード === currentRecord.locationCode &&
            (line.使用停止フラグ === 0 || line.使用停止フラグ === '0')
          );
          setFilteredLines(filtered);
          if (currentRecord.lineCode && !filtered.find(l => l.製造ラインコード === currentRecord.lineCode)) {
            handleInputChange('lineCode', '');
          }
        } else {
          setFilteredLines([]);
          if (currentRecord.lineCode) handleInputChange('lineCode', '');
        }
      }, [currentRecord.locationCode, lineMaster]);

      const loadMasterData = () => {
        try {
          if (typeof 製造ラインマスタ !== 'undefined' && Array.isArray(製造ラインマスタ)) {
            const active = 製造ラインマスタ.filter(r => (r.使用停止フラグ === 0 || r.使用停止フラグ === '0'));
            setLineMaster(active);
            setMasterLoadError('');
          } else {
            setMasterLoadError('製造ラインマスタ.jsが読み込まれていません');
          }
        } catch (e) {
          setMasterLoadError('製造ラインマスタの読み込みに失敗しました: ' + e.message);
        }
      };

      const handleInputChange = (field, value, process=null) => {
        if (process) {
          setCurrentRecord(prev => ({ ...prev, [process]: { ...prev[process], [field]: value } }));
        } else {
          setCurrentRecord(prev => ({ ...prev, [field]: value }));
        }
        const key = process ? (process + '.' + field) : field;
        if (errors[key]) {
          setErrors(prev => { const ne = { ...prev }; delete ne[key]; return ne; });
        }
      };

      const handleOrderNumberBlur = () => {
        if (currentRecord.orderNumber) {
          const numbers = currentRecord.orderNumber.replace(/\D/g, '');
          const padded = numbers.padStart(15, '0').slice(0, 15);
          setCurrentRecord(prev => ({ ...prev, orderNumber: padded }));
        }
      };

      // ===== カメラUI（ボタン押下後だけ表示） =====
      const openScanPanel = async () => {
        setScanError('');
        setScanInfo('');
        setScanPanelOpen(true);
        await enumerateCameras();
      };

      const closeScanPanel = () => {
        stopQRScan();
        setScanPanelOpen(false);
      };

      const enumerateCameras = async () => {
        try {
          try { await navigator.mediaDevices.getUserMedia({ video: true, audio: false }); } catch(_) {}
          const devices = await navigator.mediaDevices.enumerateDevices();
          const vids = devices.filter(d => d.kind === 'videoinput');
          setCameras(vids);
          if (vids.length > 0 && !selectedDeviceId) setSelectedDeviceId(vids[0].deviceId);
        } catch(e) {
          console.warn('カメラ列挙に失敗:', e);
        }
      };

      const beginScan = async () => {
        if (!jsQRRef.current) { setScanError('QRコードスキャナーの読み込み中です...'); return; }
        setScanError('');
        try {
          setIsScanning(true);
          isScanningRef.current = true;
          // DOM描画完了を待つ
          await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

          const constraints = selectedDeviceId
            ? { video: { deviceId: { exact: selectedDeviceId }, width:{ ideal:1280 }, height:{ ideal:720 } }, audio:false }
            : { video: { facingMode:{ ideal:'environment' }, width:{ ideal:1280 }, height:{ ideal:720 } }, audio:false };

          const stream = await navigator.mediaDevices.getUserMedia(constraints);
          streamRef.current = stream;
          setScanInfo('constraints: ' + JSON.stringify(constraints.video));

          const v = videoRef.current;
          if (!v) throw new Error('video要素が見つかりません');
          v.srcObject = stream;
          v.setAttribute('playsinline', '');
          v.setAttribute('autoplay', '');
          v.muted = true;

          await v.play().catch(()=>{});
          await new Promise((resolve) => {
            if (v.readyState >= 2 && v.videoWidth > 0) resolve();
            v.onloadedmetadata = () => resolve();
            v.onloadeddata = () => resolve();
          });

          // ループ開始
          requestAnimationFrame(scanLoop);
        } catch (err) {
          setIsScanning(false);
          isScanningRef.current = false;
          if (err.name === 'NotAllowedError') setScanError('カメラへのアクセスが拒否されました。ブラウザの許可設定をご確認ください。');
          else if (err.name === 'NotFoundError') setScanError('カメラデバイスが見つかりません。外付けカメラの接続や権限をご確認ください。');
          else if (err.name === 'OverconstrainedError') setScanError('指定したカメラが利用できません。別のカメラを選択してください。');
          else setScanError('カメラの初期化に失敗しました: ' + err.message);
          console.error(err);
        }
      };

      // ===== デコード・ループ（常に最新の状態参照: isScanningRef） =====
      const drawLine = (ctx, begin, end) => {
        ctx.beginPath();
        ctx.moveTo(begin.x, begin.y);
        ctx.lineTo(end.x, end.y);
        ctx.lineWidth = 3;
        ctx.strokeStyle = '#22c55e';
        ctx.stroke();
      };

      const scanLoop = () => {
        if (!isScanningRef.current) return;
        const v = videoRef.current;
        const c = canvasRef.current;
        const overlay = overlayRef.current;
        if (!v || !c) { requestAnimationFrame(scanLoop); return; }

        const vw = v.videoWidth || 0;
        const vh = v.videoHeight || 0;
        if (vw > 0 && vh > 0) {
          const ctx = c.getContext('2d', { willReadFrequently: true });
          const maxSide = 720;
          const scale = Math.min(1, maxSide / Math.max(vw, vh));
          c.width = Math.round(vw * scale);
          c.height = Math.round(vh * scale);
          // スムージングOFFでシャープに
          ctx.imageSmoothingEnabled = false;
          ctx.drawImage(v, 0, 0, c.width, c.height);
          const img = ctx.getImageData(0, 0, c.width, c.height);

          const code = jsQRRef.current(img.data, img.width, img.height, { inversionAttempts: 'attemptBoth' });

          // オーバーレイ描画
          if (overlay) {
            overlay.width = c.width;
            overlay.height = c.height;
            const octx = overlay.getContext('2d');
            octx.clearRect(0, 0, overlay.width, overlay.height);
            if (code && code.location) {
              const loc = code.location;
              drawLine(octx, loc.topLeftCorner, loc.topRightCorner);
              drawLine(octx, loc.topRightCorner, loc.bottomRightCorner);
              drawLine(octx, loc.bottomRightCorner, loc.bottomLeftCorner);
              drawLine(octx, loc.bottomLeftCorner, loc.topLeftCorner);
            }
          }

          if (code && code.data) {
            handleInputChange('orderNumber', String(code.data));
            closeScanPanel();
            return;
          }
        }
        requestAnimationFrame(scanLoop);
      };

      const stopQRScan = () => {
        isScanningRef.current = false;
        if (streamRef.current) {
          streamRef.current.getTracks().forEach(t => t.stop());
          streamRef.current = null;
        }
        setIsScanning(false);
      };

      // ===== バリデーション他 =====
      const validateTimeValue = (value, fieldName, process) => {
        const newErrors = {};
        if (value) {
          const num = parseFloat(value);
          if (!isNaN(num) && num < 0) newErrors[process + '.' + fieldName] = '負数は入力できません';
          else if (!isNaN(num) && (num * 4) % 1 !== 0) newErrors[process + '.' + fieldName] = '0.25h単位で入力してください';
        }
        return newErrors;
      };

      const validateRecord = () => {
        const ne = {};
        if (!currentRecord.date) ne.date = '必須項目です。入力してください';
        if (!currentRecord.orderNumber) ne.orderNumber = '必須項目です。入力してください';
        if (!currentRecord.locationCode) ne.locationCode = '必須項目です。入力してください';
        if (!currentRecord.lineCode) ne.lineCode = '必須項目です。入力してください';

        const fields = ['setup','production','allowance','unpacking','rework','people'];
        fields.forEach(f => { if (!currentRecord.filling[f]) ne['filling.'+f] = '必須項目です。入力してください'; });
        fields.forEach(f => { if (!currentRecord.finishing[f]) ne['finishing.'+f] = '必須項目です。入力してください'; });

        ['filling','finishing'].forEach(p => {
          ['setup','production','allowance','unpacking','rework'].forEach(f => {
            Object.assign(ne, validateTimeValue(currentRecord[p][f], f, p));
          });
        });

        ['filling','finishing'].forEach(p => {
          const v = currentRecord[p].people;
          if (v !== '') {
            const n = parseFloat(v);
            if (!isNaN(n) && !Number.isInteger(n)) ne[p+'.people'] = '整数で入力してください';
          }
        });

        setErrors(ne);
        return Object.keys(ne).length === 0;
      };

      const addRecord = () => {
        if (!validateRecord()) return;
        const fillingRecord = { id: Date.now(), date: currentRecord.date, orderNumber: currentRecord.orderNumber, locationCode: currentRecord.locationCode, lineCode: currentRecord.lineCode, process: '充填', ...currentRecord.filling };
        const finishingRecord = { id: Date.now()+1, date: currentRecord.date, orderNumber: currentRecord.orderNumber, locationCode: currentRecord.locationCode, lineCode: currentRecord.lineCode, process: '仕上', ...currentRecord.finishing };
        setRecords(prev => [...prev, fillingRecord, finishingRecord]);
        setCurrentRecord({
          date: new Date().toISOString().split('T')[0],
          orderNumber: '',
          locationCode: '',
          lineCode: '',
          filling: { setup:'', production:'', allowance:'', unpacking:'', rework:'', people:'' },
          finishing: { setup:'', production:'', allowance:'', unpacking:'', rework:'', people:'' }
        });
        setErrors({});
      };

      const deleteRecord = (id) => setRecords(prev => prev.filter(r => r.id !== id));

      const downloadCSV = () => {
        if (records.length === 0) { alert('ダウンロードするデータがありません'); return; }
        const headers = ['記入日','指図書番号','製造場所コード','製造ラインコード','工程','段取り','実生産','余裕','開梱','手直し','人数'];
        const csv = [
          headers.join(','),
          ...records.map(r => [r.date,r.orderNumber,r.locationCode,r.lineCode,r.process,r.setup,r.production,r.allowance,r.unpacking,r.rework,r.people].join(','))
        ].join('\n');
        const bom = '\uFEFF';
        const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `工数実績_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      return (
        <div className="min-h-screen bg-gray-100 p-4">
          <div className="max-w-6xl mx-auto">
            <div className="bg-white rounded-lg shadow-md p-6 mb-6">
              <h1 className="text-2xl font-bold text-gray-800 mb-2">工数実績収集フォーム</h1>
              <p className="text-sm text-gray-600 mb-6">充填・仕上同時入力版</p>

              {/* マスタ */}
              <div className="mb-6 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-medium text-gray-700">製造ラインマスタ</p>
                    {masterLoadError
                      ? <p className="text-xs text-red-600">{masterLoadError}</p>
                      : (lineMaster.length > 0
                        ? <p className="text-xs text-green-600">読み込み済み（{lineMaster.length}件）</p>
                        : <p className="text-xs text-yellow-600">データがありません</p>)}
                  </div>
                  <button onClick={loadMasterData} className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm flex items-center gap-2">
                    <RefreshCw /> 製造ラインマスタ読込
                  </button>
                </div>
              </div>

              {/* 共通項目 */}
              <div className="mb-6">
                <h3 className="text-lg font-semibold text-gray-800 mb-4">共通項目</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">記入日 <span className="text-red-500">*</span></label>
                    <input type="date" value={currentRecord.date} onChange={e => handleInputChange('date', e.target.value)}
                      className={`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${errors.date ? 'border-red-500':'border-gray-300'}`} />
                    {errors.date && <p className="text-red-500 text-xs mt-1">{errors.date}</p>}
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">指図書番号 <span className="text-red-500">*</span></label>
                    <div className="flex gap-2">
                      <div className="flex-1">
                        <input type="text" value={currentRecord.orderNumber}
                          onChange={e => handleInputChange('orderNumber', e.target.value)}
                          onBlur={handleOrderNumberBlur} placeholder="手入力またはスキャン"
                          className={`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${errors.orderNumber ? 'border-red-500':'border-gray-300'}`} />
                        {errors.orderNumber && <p className="text-red-500 text-xs mt-1">{errors.orderNumber}</p>}
                      </div>
                      <button onClick={openScanPanel}
                        className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        <Camera size={20}/>
                      </button>
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">製造場所コード <span className="text-red-500">*</span></label>
                    <select value={currentRecord.locationCode} onChange={e => handleInputChange('locationCode', e.target.value)}
                      className={`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${errors.locationCode ? 'border-red-500':'border-gray-300'}`}>
                      <option value="">選択してください</option>
                      {locationCodeOptions.map(code => <option key={code} value={code}>{code}</option>)}
                    </select>
                    {errors.locationCode && <p className="text-red-500 text-xs mt-1">{errors.locationCode}</p>}
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">製造ラインコード <span className="text-red-500">*</span></label>
                    <select value={currentRecord.lineCode} onChange={e => handleInputChange('lineCode', e.target.value)}
                      disabled={!currentRecord.locationCode || filteredLines.length===0}
                      className={`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${errors.lineCode ? 'border-red-500':'border-gray-300'} disabled:bg-gray-100 disabled:cursor-not-allowed`}>
                      <option value="">選択してください</option>
                      {filteredLines.map(line => (
                        <option key={line.製造ラインコード} value={line.製造ラインコード}>
                          {line.製造ラインコード} - {line.製造ライン名}
                        </option>
                      ))}
                    </select>
                    {errors.lineCode && <p className="text-red-500 text-xs mt-1">{errors.lineCode}</p>}
                  </div>
                </div>
              </div>

              {/* 充填工程 */}
              <div className="mb-6 p-4 bg-blue-50 rounded-lg">
                <h3 className="text-lg font-semibold text-blue-800 mb-4">充填工程</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  {[
                    {k:'setup',label:'段取り（時間）'},
                    {k:'production',label:'実生産（時間）'},
                    {k:'allowance',label:'余裕（時間）'},
                    {k:'unpacking',label:'開梱（時間）'},
                    {k:'rework',label:'手直し（時間）'},
                  ].map(({k,label}) => {
                    const key = 'filling.' + k;
                    return (
                      <div key={'filling_'+k}>
                        <label className="block text-sm font-medium text-gray-700 mb-1">{label} <span className="text-red-500">*</span></label>
                        <input type="number" step="0.25" min="0" value={currentRecord.filling[k]}
                          onChange={e => handleInputChange(k, e.target.value, 'filling')}
                          className={`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${errors[key] ? 'border-red-500':'border-gray-300'}`} />
                        {errors[key] && <p className="text-red-500 text-xs mt-1">{errors[key]}</p>}
                      </div>
                    );
                  })}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">人数 <span className="text-red-500">*</span></label>
                    <input type="number" step="1" min="1" value={currentRecord.filling.people}
                      onChange={e => handleInputChange('people', e.target.value, 'filling')}
                      className={`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${errors['filling.people'] ? 'border-red-500':'border-gray-300'}`} />
                    {errors['filling.people'] && <p className="text-red-500 text-xs mt-1">{errors['filling.people']}</p>}
                  </div>
                </div>
              </div>

              {/* 仕上工程 */}
              <div className="mb-6 p-4 bg-green-50 rounded-lg">
                <h3 className="text-lg font-semibold text-green-800 mb-4">仕上工程</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  {[
                    {k:'setup',label:'段取り（時間）'},
                    {k:'production',label:'実生産（時間）'},
                    {k:'allowance',label:'余裕（時間）'},
                    {k:'unpacking',label:'開梱（時間）'},
                    {k:'rework',label:'手直し（時間）'},
                  ].map(({k,label}) => {
                    const key = 'finishing.' + k;
                    return (
                      <div key={'finishing_'+k}>
                        <label className="block text-sm font-medium text-gray-700 mb-1">{label} <span className="text-red-500">*</span></label>
                        <input type="number" step="0.25" min="0" value={currentRecord.finishing[k]}
                          onChange={e => handleInputChange(k, e.target.value, 'finishing')}
                          className={`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${errors[key] ? 'border-red-500':'border-gray-300'}`} />
                        {errors[key] && <p className="text-red-500 text-xs mt-1">{errors[key]}</p>}
                      </div>
                    );
                  })}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">人数 <span className="text-red-500">*</span></label>
                    <input type="number" step="1" min="1" value={currentRecord.finishing.people}
                      onChange={e => handleInputChange('people', e.target.value, 'finishing')}
                      className={`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${errors['finishing.people'] ? 'border-red-500':'border-gray-300'}`} />
                    {errors['finishing.people'] && <p className="text-red-500 text-xs mt-1">{errors['finishing.people']}</p>}
                  </div>
                </div>
              </div>

              <button onClick={addRecord} className="w-full py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 font-semibold flex items-center justify-center gap-2">
                <Plus size={20}/> レコードを追加（充填・仕上 2件）
              </button>
            </div>

            {records.length > 0 && (
              <div className="bg-white rounded-lg shadow-md p-6">
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold text-gray-800">登録済みデータ（{records.length}件）</h2>
                  <button onClick={downloadCSV} className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center gap-2">
                    <Download size={20}/> CSV出力
                  </button>
                </div>

                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-3 py-2 text-left text-gray-700">記入日</th>
                        <th className="px-3 py-2 text-left text-gray-700">指図書番号</th>
                        <th className="px-3 py-2 text-left text-gray-700">製造場所</th>
                        <th className="px-3 py-2 text-left text-gray-700">製造ライン</th>
                        <th className="px-3 py-2 text-left text-gray-700">工程</th>
                        <th className="px-3 py-2 text-right text-gray-700">段取り</th>
                        <th className="px-3 py-2 text-right text-gray-700">実生産</th>
                        <th className="px-3 py-2 text-right text-gray-700">余裕</th>
                        <th className="px-3 py-2 text-right text-gray-700">開梱</th>
                        <th className="px-3 py-2 text-right text-gray-700">手直し</th>
                        <th className="px-3 py-2 text-right text-gray-700">人数</th>
                        <th className="px-3 py-2 text-center text-gray-700">操作</th>
                      </tr>
                    </thead>
                    <tbody>
                      {records.map(record => (
                        <tr key={record.id} className="border-t border-gray-200 hover:bg-gray-50">
                          <td className="px-3 py-2">{record.date}</td>
                          <td className="px-3 py-2">{record.orderNumber}</td>
                          <td className="px-3 py-2">{record.locationCode}</td>
                          <td className="px-3 py-2">{record.lineCode}</td>
                          <td className="px-3 py-2">
                            <span className={`px-2 py-1 rounded text-xs ${record.process === '充填' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}`}>
                              {record.process}
                            </span>
                          </td>
                          <td className="px-3 py-2 text-right">{record.setup}</td>
                          <td className="px-3 py-2 text-right">{record.production}</td>
                          <td className="px-3 py-2 text-right">{record.allowance}</td>
                          <td className="px-3 py-2 text-right">{record.unpacking}</td>
                          <td className="px-3 py-2 text-right">{record.rework}</td>
                          <td className="px-3 py-2 text-right">{record.people}</td>
                          <td className="px-3 py-2 text-center">
                            <button onClick={() => deleteRecord(record.id)} className="text-red-500 hover:text-red-700">
                              <Trash2 size={18}/>
                            </button>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}
          </div>

          {/* === スキャンパネル === */}
          {scanPanelOpen && (
            <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
              <div className="bg-white w-full max-w-2xl rounded-lg shadow-lg p-4">
                <div className="flex items-center justify-between mb-3">
                  <h3 className="font-semibold text-gray-800">QRコード読み取り</h3>
                  <button onClick={closeScanPanel} className="px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm">閉じる</button>
                </div>

                {/* カメラ選択（開始前のみ） */}
                {!isScanning && (
                  <div className="mb-4">
                    <label className="block text-sm font-medium text-gray-700 mb-1">使用カメラ</label>
                    <div className="flex gap-2">
                      <select value={selectedDeviceId} onChange={e => setSelectedDeviceId(e.target.value)} className="flex-1 px-3 py-2 border rounded-lg">
                        {cameras.length === 0 && <option value="">（カメラが見つかりません）</option>}
                        {cameras.map((c,i) => <option key={c.deviceId} value={c.deviceId}>{c.label || `カメラ ${i+1}`}</option>)}
                      </select>
                      <button onClick={enumerateCameras} className="px-3 py-2 bg-gray-700 text-white rounded hover:bg-gray-800 text-sm">再検出</button>
                      <button onClick={beginScan} className="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">開始</button>
                    </div>
                    <p className="text-xs text-gray-500 mt-1">※ この画面を開いた後にブラウザがカメラ許可を求める場合があります。</p>
                  </div>
                )}

                {/* スキャナビュー */}
                {isScanning && (
                  <div className="mb-2">
                    <div className="flex justify-between items-center mb-2">
                      <div className="text-sm text-gray-600">スキャン中… カメラにQRを映してください。</div>
                      <button onClick={stopQRScan} className="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm">停止</button>
                    </div>
                    <div className="video-wrap">
                      <video ref={videoRef} className="w-full rounded-lg bg-black object-contain" autoPlay muted playsInline />
                      <canvas ref={overlayRef} className="qr-canvas"></canvas>
                    </div>
                    <canvas ref={canvasRef} className="hidden" />
                    {scanInfo && <div className="text-xs text-gray-500 mt-2">{scanInfo}</div>}
                  </div>
                )}

                {scanError && <div className="p-2 bg-red-100 text-red-700 rounded text-sm">{scanError}</div>}
              </div>
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<WorkHoursForm />);
  </script>
</body>
</html>
